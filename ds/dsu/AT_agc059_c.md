考虑排列不合法的条件。

一定存在一个数对 $x,y$，在询问之前确定大小关系，这说明存在一条链 $x < u_1 < u_2 < \cdots < u_m < y$ 已经被确定，不妨设这是能在询问之前确定的最短的链，则 $x < u_1 < u_2$ 不能在询问 $x,u_2$ 的关系之前确定，则 $x,u_2$ 的询问在 $x,y$ 的询问之前，这意味着存在一条更短的链被确定：$x < u_2 < u_3 < \cdots < u_m < y$。否则存在一个长度只有 $3$ 的链。

所以只需考虑长度为 $3$ 的链。如果存在 $x,y$ 和 $y,z$ 比 $x,z$ 的询问出现地早，则 $y$ 要么是最大的，要么是最小的。为每个数对的一种大小关系建立一个结点，如果两个结点有连边说明两个结点的条件等价。

这样可以处理出合并信息，如果 $x > y$ 和 $y > x$ 被合并，则判定为无解。否则对于每个连通块，确定一个条件就确定了整个连通块，方案数为 $2$ 的连通块次幂。

时间复杂度 $O(n^3 \log n)$。
