考虑建线段树维护整个 $b$ 序列，在每个结点处维护答案。如何合并两个结点？若子区间在同一个子结点直接更新答案，否则子区间跨越中点。

考虑在每个结点处维护最靠左的第 $k$ 位（二进制）是 $1$ 的数、最靠右的第 $k$ 位是 $1$ 的数（$0 \leq k < 30$）。

合并时从高位到低位考虑：

- 若这一位上 $v$ 是 $1$，则左侧最靠右的 $1$ 和右侧最靠左的 $1$ 必须选一个。贪心选择得到的新区间的 $a$ 的最大值小的那个，如果相同，就贪心地都选（这样考虑低位的时候 $1$ 尽可能多）。
- 若这一位上 $v$ 是 $0$：
  - 若仍然选择一个 $1$，则无需考虑低位结果已经至少为 $v$，直接更新到答案里去即可。
  - 若不选择 $1$，接着考虑下一位即可。

修改操作直接在线段树上修改即可。时间复杂度 $\Theta((n+q)\log n\log\max b_i)$。
