一个点对答案的贡献就是其在点分树上的深度。一对点 $u,v$ 若满足在点分树上，$u$ 是 $v$ 的祖先或者 $v$ 是 $u$ 的祖先，就会对答案造成 $1$ 的贡献。设 $u,v$ 的距离为 $d$，即 $u$ 到 $v$ 的路径（含端点）上有 $d+1$ 个点。由于选点的概率是均匀的，$u$ 是 $v$ 的祖先当且仅当这 $d+1$ 个点中 $u$ 第一个被选中，故 $u$ 和 $v$ 有祖先关系的概率为 $d+1$。

问题转化为求出距离为 $d=1,2,\cdots$ 的点对分别有多少。考虑点分治，在一个结点上只统计点对路径经过该结点的点对。只需计算出每棵子树中各个深度的点数，注意到要让深度为 $d$，则需要两个在不同子树中找到两个深度和为 $d$ 的点，可以将各个深度的点数的数组做卷积。设有子树 $T_1,T_2,\cdots,T_m$ 的大小按照升序排序，则对于任意 $i > 1$，都令 $T_1+T_2+\cdots+T_{i-1}$ 和 $T_i$ 做卷积即可。

时间复杂度 $O(n\log^2 n)$。
