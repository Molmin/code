考虑动态规划，记 $f(i,r,c)$ 表示正好占用了 $r$ 行 $c$ 列，填了 $1 \sim i$ 的所有颜色的棋子的方案数。

则令 $f(i-1,r-p,c-q)$ 向 $f(i,r,c)$ 转移，系数为 $\dbinom{n-r+p}{p} \dbinom{m-c+q}{q}$ 乘上正好在 $p$ 行 $q$ 列中放置 $a_i$ 个棋子的方案数。

考虑对于每个 $a_i$ 预处理 $g(r,c)$ 表示正好在 $r$ 行 $c$ 列中放置 $a_i$ 个棋子的方案数。对于 $g(r,c)$ 的计算，考虑容斥原理，用总方案数 $\dbinom{rc}{x}$ 减去存在空行或空列的方案数，枚举非空行数量 $p$ 和非空列数量 $q$，则需要减去 $\dbinom rp \dbinom cq \cdot g(p,q)$。

预处理 $g$ 之后按照上述算法求 $f$ 即可。时间复杂度 $\Theta(n^2 m^2 c)$。
