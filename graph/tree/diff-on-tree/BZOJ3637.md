考虑在每个结点处维护把这个点改成黑色或白色时，子树中所在颜色连通块的大小 $f$。

对于查询，等价于从这个结点向上找到第一个父亲与自己颜色不同的点，然后查询 $f$ 值就是答案。

对于修改，等价于从这个结点 $u$ 向上找到第一个父亲与自己颜色不同的点，然后把两点路径上都减去或加上 $u$ 的 $f$ 值。

$f$ 的批量修改可以用树上差分和树状数组完成维护；找到第一个父亲与自己颜色不同的点可以树剖，每条链上维护深度最大的黑点或白点和黑点集合和白点集合，查询第一个父亲与自己颜色不同的点只需不断网上跳直到找到为止。

时间复杂度 $\Theta(n\log n+m\log^2 n)$。
