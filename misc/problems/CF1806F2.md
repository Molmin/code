考虑对两个相同的数进行一次操作，这时相当于删掉了其中之一，下面暂时忽略相同的数，即假设所有数都是不同的。

易知问题等价于把整个序列分为 $n-k$ 组，答案为每组的 $\gcd$ 之和的最大值。

**结论一：只存在一组中包含多个数。**

> 证明：
> 
> 若存在两组包含多个数，设两组数分别为集合 $A$ 和集合 $B$，不妨设 $\gcd A=x\geq\gcd B=y$，$A$ 中的最大值为 $t$。
> 
> 考虑把 $A,B$ 重新划分为 $\{t\}$ 和 $A\cup B-\{t\}$。贡献的变化量为 $\gcd\left(A\cup B-\{t\}\right)+t-x-y\geq\gcd(x,y)+2x-x-y\geq\gcd(x,y)+x-y>0$。
> 
> 所以新的划分更加优秀，结论一得证。

**结论二：包含多个数的组必定包含最小的数。**

> 证明：
> 
> 若不包含最小的数，设最小的数为 $x$，包含多个数的集合为 $S$，集合中最大的数为 $y$。
> 
> 重新划分分组为 $S\cup\{x\}-\{y\}$ 和 $\{y\}$，贡献的变化量为 $\gcd\left(S\cup\{x\}-\{y\}\right)+y-x-\gcd S\geq\gcd\left(S\cup\{x\}-\{y\}\right)+y-x-(\max S-\min S)>\gcd\left(S\cup\{x\}-\{y\}\right)>0$。
> 
> 所以新的划分更加优秀，结论二得证。

对于简单版本，先预处理出重复的数按照从小到大排列的前缀和，然后枚举包含多个数的组的 $\gcd$，枚举它的倍数处理即可。

时间复杂度 $\Theta(n\log n+m\log m)$。

下面假设原序列按照从小到大排序。

**结论三：包含 $k$ 个数的组一定包含序列中最靠前的 $k-1$ 个和后面的一个。**

> 证明：
> 
> 设原来包含多个数的组为 $a_1,a_2,\cdots a_s,a_{i_1},a_{i_2},\cdots,a_{i_t}$，其中 $i_1 < i_2 < \cdots < i_t$。
> 
> 令新的组为 $a_1,a_2,\cdots a_s,a_{s+1},a_{i_1},a_{i_2},\cdots,a_{i_{t-1}}$。设集合 $S=\{a_1,a_2,\cdots a_s,a_{i_1},a_{i_2},\cdots,a_{i_{t-1}}\}$。则贡献的变化量为 $\gcd(S\cup\{a_{s+1}\})+a_{i_t}-\gcd(S\cup\{a_{i_t}\})-a_{s+1} > \gcd(S\cup\{a_{s+1}\})-\gcd(S\cup\{a_{i_t}\})+a_{i_t}-a_{i_{t-1}}\geq\gcd(S\cup\{a_{s+1}\}) > 0$。
> 
> 所以新的划分更加优秀，结论三得证。

注意到，将原序列排序后，前缀 $\gcd$ 会形成一些连续段，且段的数量为 $O(\log m)$，枚举这个 $\gcd$，暴力求出另一个数的最优取值即可。

时间复杂度 $O(n\log^2 m)$（求 $\gcd$ 占一个 $\log$）。
