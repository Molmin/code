首先容易想到每时每刻尽可能顶满每条边的限制是最优的。

考虑在所有边的限制顶满的情况下，结点 $i$ 的变化速度 $v_i$（即与其父亲的边的限制减去与其儿子的边的限制之和）。根据这个速度 $v_i$ 可以计算出这个结点人数变为 $0$ 的时间（当然也可能不能变为 $0$）。

用一个优先队列维护这些时间。每次取出一个最早的时间，在这个时间到来之前，每个点将会按照对应的 $v$ 值变化。于是我们可以直接计算出所有时间在这之前的询问的答案，即 $c_1 + v_1 t$。假设这个时间是结点 $u$ 贡献的，那么在这个时间之后，该结点将不再会有人滞留，所有进入该结点的人都可以从其与父亲的边出去，于是可以把这个结点与其父亲节点合并，即把 $v_u$ 加到其父亲的 $v$ 值上，人数也加到父亲结点上，并把其父亲结点在优先队列中的数据更新。

这样会把时间轴分为 $O(n)$ 段，对于每段都可以处理出对应的答案。使用并查集维护合并情况。时间复杂度 $O(n \log n)$。
